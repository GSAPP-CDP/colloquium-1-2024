<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive Globe</title>
  <style>
    body { margin: 0; }
    #globeViz { position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
    .infoWindow {
      position: absolute;
      background-color: hsla(0, 0%, 13%, 0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      display: none;
      pointer-events: none;
      z-index: 10;
    }
  </style>
  <script src="//unpkg.com/topojson-client"></script>
  <script src="//unpkg.com/globe.gl"></script>
  <script src="//unpkg.com/three/build/three.module.js"></script>
</head>
<body>
  <div id="globeViz"></div>
  <div class="infoWindow" id="infoWindow"></div>

  <script type="module">
    import * as THREE from '//unpkg.com/three/build/three.module.js';

    const world = Globe()
      (document.getElementById('globeViz'))
      .backgroundColor('black')
      .showGlobe(false)
      .showAtmosphere(false);

    let selectedCountry = null;

    const clickableCountries = [
      'United States of America', 'China', 'United Kingdom', 'Canada', 
      'Spain', 'Brazil', 'Australia', 'United Arab Emirates'
    ];

    // Load country data for the hollow globe
    fetch('//unpkg.com/world-atlas/countries-110m.json')
      .then(res => res.json())
      .then(countriesTopo => {
        const countries = topojson.feature(countriesTopo, countriesTopo.objects.countries).features;
        
        countries.forEach(country => {
          console.log(country.properties.name, country.id); // Debugging log
          country.clickable = clickableCountries.includes(country.properties.name);
        });

        world
          .polygonsData(countries)
          .polygonCapColor(d => {
            if (selectedCountry && d.id === selectedCountry.id) {
              return 'rgba(240, 173, 109, 0.81)'; // Highlight selected country
            }
            return d.clickable ? 'rgba(192, 192, 192, 1)' : 'rgba(53, 53, 53, 1)'; // Light grey for clickable, dark grey for non-clickable
          })
          .polygonSideColor(() => 'rgba(0,0,0,0)')
          .polygonStrokeColor(() => 'rgba(30, 30, 30, 1)')
          .onPolygonClick(d => {
            if (d.clickable) {
              selectedCountry = selectedCountry && selectedCountry.id === d.id ? null : d;
              world.polygonsData(countries);  // Trigger re-render
            }
          });
      });


    // Specific locations for rings
    const locations = [
      { lat: 22.3193, lng: 114.1694, maxR: 12, city: 'Hong Kong' },
      { lat: 51.5074, lng: -0.1278, maxR: 5, city: 'London' },
      { lat: 39.9042, lng: 116.4074, maxR: 3, city: 'Beijing' },
      { lat: 47.5615, lng: -52.7126, maxR: 3, city: "St. John's" },
      { lat: 25.2048, lng: 55.2708, maxR: 17, city: 'Dubai' },
      { lat: 43.651070, lng: -79.347015, maxR: 6, city: 'Toronto' },
      { lat: -33.8688, lng: 151.2093, maxR: 8, city: 'Sydney' },
      { lat: 40.4168, lng: -3.7038, maxR: 5, city: 'Madrid' },
      { lat: -23.5505, lng: -46.6333, maxR: 3, city: 'SÃ£o Paulo' }
    ];

    const gData = locations.map(location => ({
      lat: location.lat,
      lng: location.lng,
      maxR: location.maxR,
      city: location.city,
      propagationSpeed: 1,
      repeatPeriod: 1000
    }));

    const colorInterpolator = t => `rgba(255,100,50,${Math.sqrt(1-t)})`;

    const ringMaterial = new THREE.MeshBasicMaterial({
      color: 0xff6432,
      side: THREE.DoubleSide,
      transparent: true,
      opacity: 0.7
    });

    world
      .ringsData(gData)
      .ringColor(() => colorInterpolator)
      .ringMaxRadius('maxR')
      .ringPropagationSpeed('propagationSpeed')
      .ringRepeatPeriod('repeatPeriod')
      .ringAltitude(0.02)
      .ringMaterial(() => ringMaterial)
      .onRingClick((ring, event) => {
        const { lat, lng, city } = ring;
        const infoWindow = document.getElementById('infoWindow');
        infoWindow.innerText = city;
        infoWindow.style.left = `${event.clientX + 10}px`;
        infoWindow.style.top = `${event.clientY + 10}px`;
        infoWindow.style.display = 'block';
        event.stopPropagation(); // Prevent click from immediately hiding the info window
      });

    document.addEventListener('click', (event) => {
      const infoWindow = document.getElementById('infoWindow');
      if (!event.target.closest('.infoWindow')) {
        infoWindow.style.display = 'none';
      }
    });
  </script>
</body>
</html>
